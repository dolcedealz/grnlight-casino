<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#121212">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Greenlight Casino</title>
    
    <!-- Критический CSS инлайн для быстрого первоначального рендеринга -->
    <style>
        :root {
            --primary-green: #00A86B;
            --gold: #FFD700;
            --dark-gray: #121212;
            --black: #000000;
            --white: #FFFFFF;
        }
        
        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background-color: var(--dark-gray);
            color: var(--white);
            overflow-x: hidden;
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }
        
        .app-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background: var(--dark-gray);
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--dark-gray);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 0.3s ease;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary-green);
            animation: spin 1s linear infinite;
        }
        
        .loading-text {
            color: var(--white);
            font-size: 1.2rem;
            margin-top: 1.5rem;
            text-align: center;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Скрытие всего контента до инициализации */
        .app-content {
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .app-content.loaded {
            display: block;
            opacity: 1;
        }
        
        /* Новый стиль для режима события, верхний прямоугольник */
        .events-card {
            width: 100%;
            background: linear-gradient(135deg, #314755 0%, #26a0da 100%);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        .events-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect x="0" y="0" width="50" height="50" fill="rgba(255,255,255,0.05)"/><rect x="50" y="50" width="50" height="50" fill="rgba(255,255,255,0.05)"/></svg>');
            opacity: 0.3;
        }
        
        .events-icon {
            font-size: 30px;
            margin-bottom: 10px;
        }
        
        .events-name {
            font-size: 18px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        /* Новая сетка с играми 2x2 */
        .game-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .game-card {
            background-color: var(--medium-gray, #2A2A2A);
            border-radius: 12px;
            padding: 20px 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
            height: 130px;
        }
        
        .game-card:hover, .game-card:active {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .game-icon {
            font-size: 36px;
            margin-bottom: 15px;
        }
        
        .game-name {
            font-size: 16px;
            font-weight: bold;
            color: var(--gold);
            text-transform: uppercase;
        }
        
        /* Стили для профиля */
        .profile-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .profile-id {
            font-family: 'Impact', sans-serif;
            color: #ffffff;
            font-size: 18px;
        }
        
        .profile-brand {
            font-family: 'Impact', sans-serif;
            color: #d4af37;
            font-size: 20px;
            font-weight: bold;
        }
        
        .profile-card {
            background-color: #333333;
            border: 2px solid #d4af37;
            border-radius: 15px;
            margin: 15px;
            overflow: hidden;
        }
        
        .card-content {
            padding: 20px;
        }
        
        .balance-info {
            margin-bottom: 15px;
        }
        
        .balance-label {
            font-family: 'SF Pro Display', Arial, sans-serif;
            font-style: italic;
            font-weight: 300;
            color: #ffffff;
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        .balance-amount {
            display: flex;
            align-items: center;
            font-family: 'Bauhaus 93', 'Arial Black', sans-serif;
            font-size: 32px;
            color: #d4af37;
        }
        
        .diamond-icon {
            margin-left: 10px;
            font-size: 28px;
        }
        
        .balance-actions {
            display: flex;
            justify-content: space-between;
            gap: 15px;
            margin: 20px 0;
        }
        
        .action-button {
            font-family: 'SF Pro Display', Arial, sans-serif;
            font-weight: 600;
            font-style: italic;
            background-color: #3a5c3a;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 0;
            width: 48%;
            text-align: center;
            font-size: 16px;
            text-transform: uppercase;
            cursor: pointer;
        }
        
        .withdraw-button {
            background-color: #333333;
            border: 1px solid #3a5c3a;
        }
        
        .activity-section {
            margin-top: 20px;
        }
        
        .activity-label {
            font-family: 'SF Pro Display', Arial, sans-serif;
            font-style: italic;
            font-weight: 300;
            color: #ffffff;
            font-size: 16px;
        }
        
        .activity-value {
            font-family: 'Impact', sans-serif;
            font-size: 30px;
            color: #ffffff;
            margin: 5px 0 15px 0;
        }
        
        .activity-label-small {
            font-family: 'SF Pro Display', Arial, sans-serif;
            font-style: italic;
            font-weight: 300;
            color: #ffffff;
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .activity-bar-container {
            width: 100%;
            height: 20px;
            background: linear-gradient(to right, #444444, #222222);
            border-radius: 10px;
            overflow: hidden;
        }
        
        .activity-bar {
            height: 100%;
            width: 30%; /* Это значение будет меняться динамически */
            background: linear-gradient(to right, #3a5c3a, #d4af37);
            border-radius: 10px;
            transition: width 0.3s ease;
        }
        
        .details-card {
            margin-top: 25px;
        }
        
        .details-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .details-icon {
            font-size: 24px;
            margin-right: 10px;
        }
        
        .details-title {
            font-family: 'Impact', sans-serif;
            font-size: 24px;
            color: #ffffff;
        }
        
        .promo-section {
            margin-bottom: 25px;
        }
        
        .promo-label {
            font-family: 'SF Pro Display', Arial, sans-serif;
            font-style: italic;
            font-weight: 300;
            color: #ffffff;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .promo-input {
            width: 100%;
            padding: 12px;
            background-color: #444444;
            border: 1px solid #555555;
            border-radius: 8px;
            color: white;
            font-family: 'SF Pro Display', Arial, sans-serif;
        }
        
        .telegram-section {
            margin-top: 20px;
        }
        
        .telegram-link {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #3a5c3a;
            color: white;
            text-decoration: none;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Impact', sans-serif;
        }
        
        .telegram-icon {
            font-size: 20px;
            margin-right: 10px;
        }
        
        .telegram-text {
            font-size: 18px;
        }
        
        /* Стили для Coin Flip */
        .coinflip-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2rem;
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
        }

        .coin-area {
            width: 200px;
            height: 200px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px auto;
        }

        .coin {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: linear-gradient(45deg, #FFD700, #FFC107);
            position: relative;
            transform-style: preserve-3d;
            transition: transform 2s ease-out;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        .bet-options {
            display: flex;
            justify-content: space-between;
            gap: 1rem;
            margin-top: 1rem;
        }

        .bet-option {
            flex: 1;
        }
    </style>
    
    <!-- Загружаем основной CSS асинхронно -->
    <link rel="preload" href="css/style.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="css/style.css"></noscript>
</head>
<body>
    <!-- Контейнер для обработки ошибок -->
    <div id="error-container" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); color: white; z-index: 10000; padding: 2rem; text-align: center; justify-content: center; align-items: center; flex-direction: column;">
        <h2>Ошибка загрузки</h2>
        <p id="error-message">Произошла непредвиденная ошибка.</p>
        <button onclick="location.reload()" style="background: #00A86B; border: none; color: white; padding: 10px 20px; margin-top: 20px; cursor: pointer; border-radius: 5px;">Перезагрузить</button>
    </div>

    <!-- Загрузочный экран -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Загрузка Greenlight Casino...</div>
        <div id="loading-progress" style="width: 80%; height: 4px; background: rgba(255,255,255,0.1); margin-top: 20px; border-radius: 2px;">
            <div id="progress-bar" style="width: 0%; height: 100%; background: #00A86B; border-radius: 2px; transition: width 0.3s;"></div>
        </div>
        <div id="loading-debug" style="margin-top: 10px; font-size: 12px; color: #888; max-width: 80%; text-align: center;"></div>
    </div>

    <!-- Контент приложения (изначально скрыт) -->
    <div class="app-content" id="app-content">
        <div class="app-container">
            <!-- Header -->
            <header class="header">
                <div class="logo">
                    <div class="green-light"></div>
                    <h1>Greenlight</h1>
                </div>
                <div class="balance">
                    <span id="balance-amount">0</span>
                    <span class="star">⭐</span>
                </div>
            </header>

            <!-- Main Content -->
            <main class="main-content">
                <!-- Welcome Screen -->
                <div id="welcome-screen" class="screen active">
                    <div class="game-selection">
                        <h2>Выберите игру</h2>
                        
                        <!-- Верхний прямоугольник для ставок на события -->
                        <div class="events-card" data-game="events">
                            <div class="events-icon">📊</div>
                            <div class="events-name">Ставки на события</div>
                        </div>
                        
                        <!-- Сетка 2x2 для игр -->
                        <div class="game-grid">
                            <!-- Верхний ряд -->
                            <div class="game-card" data-game="slots">
                                <div class="game-icon">🎰</div>
                                <div class="game-name">Слоты</div>
                            </div>
                            <div class="game-card" data-game="miner">
                                <div class="game-icon">💣</div>
                                <div class="game-name">Майнер</div>
                            </div>
                            
                            <!-- Нижний ряд -->
                            <div class="game-card" data-game="coinflip">
                                <div class="game-icon">🪙</div>
                                <div class="game-name">Coin Flip</div>
                            </div>
                            <div class="game-card" data-game="crush">
                                <div class="game-icon">📈</div>
                                <div class="game-name">Краш</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Slots Game Screen -->
                <div id="slots-screen" class="screen">
                    <div class="game-header">
                        <button class="back-btn">← Назад</button>
                        <h2>Слоты</h2>
                    </div>
                    <div class="slots-container">
                        <div class="slot-reels">
                            <!-- Слоты будут созданы динамически через JavaScript -->
                        </div>
                        <div id="slots-result" class="result"></div>
                        <div class="bet-controls">
                            <div class="bet-amount">
                                <label for="slots-bet">Ставка:</label>
                                <input type="number" id="slots-bet" min="1" value="10">
                            </div>
                            <button id="spin-btn" class="action-btn">КРУТИТЬ</button>
                        </div>
                    </div>
                </div>
                
                <!-- Miner Game Screen -->
                <div id="miner-screen" class="screen">
                    <div class="game-header">
                        <button class="back-btn">← Назад</button>
                        <h2>Майнер</h2>
                    </div>
                    <!-- Содержимое игры Miner -->
                </div>
                
                <!-- Coin Flip Game Screen -->
                <div id="coinflip-screen" class="screen">
                    <div class="game-header">
                        <button class="back-btn">← Назад</button>
                        <h2>Coin Flip</h2>
                    </div>
                    <div class="coinflip-container">
                        <div class="coin-area">
                            <!-- Здесь будет отображаться монета -->
                            <div id="coin" class="coin"></div>
                        </div>
                        <div id="coinflip-result" class="result"></div>
                        <div class="bet-controls">
                            <div class="bet-amount">
                                <label for="coinflip-bet">Ставка:</label>
                                <input type="number" id="coinflip-bet" min="1" value="10">
                            </div>
                            <div class="bet-options">
                                <button id="bet-heads" class="action-btn bet-option">ОРЁЛ</button>
                                <button id="bet-tails" class="action-btn bet-option">РЕШКА</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Crush Game Screen -->
                <div id="crush-screen" class="screen">
                    <div class="game-header">
                        <button class="back-btn">← Назад</button>
                        <h2>Краш</h2>
                    </div>
                    <!-- Содержимое игры Crush -->
                </div>
                
                <!-- События Screen -->
                <div id="events-screen" class="screen">
                    <div class="game-header">
                        <button class="back-btn">← Назад</button>
                        <h2>Ставки на события</h2>
                    </div>
                    <div class="events-container">
                        <p class="coming-soon">Функционал ставок на события будет доступен в ближайшее время</p>
                    </div>
                </div>
                
                <!-- Профиль - экран -->
                <div id="profile-screen" class="screen">
                    <!-- Header с ID и брендом -->
                    <div class="profile-header">
                        <div class="profile-id">ID 101</div>
                        <div class="profile-brand">GREENLIGHT</div>
                    </div>
                    
                    <!-- Карточка баланса -->
                    <div class="profile-card balance-card">
                        <div class="card-content">
                            <div class="balance-info">
                                <div class="balance-label">Основной счет</div>
                                <div class="balance-amount">
                                    <span id="profile-balance-value">2.02</span>
                                    <span class="diamond-icon">💎</span>
                                </div>
                            </div>
                            
                            <div class="balance-actions">
                                <button class="action-button deposit-button">ПОПОЛНИТЬ</button>
                                <button class="action-button withdraw-button">ВЫВЕСТИ</button>
                            </div>
                            
                            <div class="activity-section">
                                <div class="activity-label">Бонусы за активность</div>
                                <div class="activity-value" id="activity-points">215</div>
                                
                                <div class="activity-label-small">Шкала активности</div>
                                <div class="activity-bar-container">
                                    <div class="activity-bar" id="activity-progress"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Карточка с детализацией -->
                    <div class="profile-card details-card">
                        <div class="card-content">
                            <div class="details-header">
                                <span class="details-icon">📋</span>
                                <span class="details-title">ДЕТАЛИЗАЦИЯ</span>
                            </div>
                            
                            <div class="promo-section">
                                <div class="promo-label">Промокод</div>
                                <input type="text" class="promo-input" id="promo-code" placeholder="Введите промокод">
                            </div>
                            
                            <div class="telegram-section">
                                <a href="https://t.me/+0Ulm9RJ0wi41Yzhi" class="telegram-link">
                                    <span class="telegram-icon">📱</span>
                                    <span class="telegram-text">ТЕЛЕГРАММ КАНАЛ</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <!-- Modals -->
            <div id="history-modal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>История</h2>
                        <span class="close-modal">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div id="history-list" class="history-list">
                            <!-- История игр будет добавлена динамически -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bottom Navigation -->
            <nav class="bottom-nav">
                <button id="history-btn" class="nav-btn">
                    <span class="nav-icon">📜</span>
                    <span class="nav-label">История</span>
                </button>
                <button id="home-btn" class="nav-btn active">
                    <span class="nav-icon">🏠</span>
                    <span class="nav-label">Главная</span>
                </button>
                <button id="profile-btn" class="nav-btn">
                    <span class="nav-icon">👤</span>
                    <span class="nav-label">Профиль</span>
                </button>
            </nav>
        </div>
    </div>

    <!-- Определение глобального хранилища данных -->
    <script>
        // Создаем глобальное пространство имен для хранения состояния приложения
        window.GreenLightApp = {
            // Версия приложения
            version: '1.1.0',
            
            // Состояние загрузки
            loading: {
                started: Date.now(),
                scriptsLoaded: false,
                mainInitialized: false,
                telegramInitialized: false,
                gamesInitialized: false,
                uiReady: false,
                errors: []
            },
            
            // Хранилище для игр
            games: {
                slots: { loaded: false, instance: null },
                miner: { loaded: false, instance: null },
                coinflip: { loaded: false, instance: null },
                crush: { loaded: false, instance: null },
                events: { loaded: false, instance: null }
            },
            
            // Пользовательские данные
            user: {
                telegramId: null,
                firstName: 'Игрок',
                lastName: '',
                username: '',
                balance: 1000,
                activity: {
                    points: 215,
                    dailyRolled: 0,
                    lastReset: null
                }
            },
            
            // Журнал действий (для отладки)
            log: function(source, message, isError = false) {
                const timestamp = new Date().toISOString().substr(11, 8);
                const logMessage = `[${timestamp}][${source}] ${message}`;
                
                if (isError) {
                    console.error(logMessage);
                    this.loading.errors.push(logMessage);
                } else {
                    console.log(logMessage);
                }
                
                // Отображаем лог в отладочном элементе
                const debugElement = document.getElementById('loading-debug');
                if (debugElement && isError) {
                    debugElement.textContent = message;
                }
                
                return logMessage;
            }
        };
        
        // Функция для регистрации игры
        window.registerGame = function(name, instance) {
            if (!window.GreenLightApp) return;
            
            // Короткое имя игры (без "Game" в конце)
            const shortName = name.replace('Game', '').toLowerCase();
            
            if (window.GreenLightApp.games[shortName]) {
                window.GreenLightApp.games[shortName].loaded = true;
                window.GreenLightApp.games[shortName].instance = instance;
                window.GreenLightApp.log('GameRegistry', `Игра ${name} зарегистрирована`);
            } else {
                window.GreenLightApp.log('GameRegistry', `Ошибка: неизвестная игра ${name}`, true);
            }
        };
    </script>

    <!-- Улучшенная система загрузки скриптов -->
    <script>
        // Инициализация процесса загрузки
        document.addEventListener('DOMContentLoaded', function() {
            try {
                window.GreenLightApp.log('Loader', 'DOM загружен, начинаем загрузку');
                
                // Сначала загружаем базовые функции
                loadTelegramApi()
                    .then(() => {
                        return Promise.all([
                            loadBootstrapScripts(),
                            loadMainApp()
                        ]);
                    })
                    .then(() => {
                        window.GreenLightApp.loading.scriptsLoaded = true;
                        window.GreenLightApp.log('Loader', 'Основные скрипты загружены');
                        
                        // Запускаем инициализацию приложения
                        if (window.casinoApp && typeof window.casinoApp.init === 'function') {
                            window.casinoApp.init().catch(error => {
                                window.GreenLightApp.log('Loader', `Ошибка инициализации: ${error.message}`, true);
                            });
                        } else {
                            window.GreenLightApp.log('Loader', 'Ошибка: casinoApp не найден', true);
                        }
                    })
                    .catch(error => {
                        window.GreenLightApp.log('Loader', `Критическая ошибка загрузки: ${error.message}`, true);
                        showErrorScreen(error.message);
                    });
                
                // Устанавливаем аварийный таймер для удаления экрана загрузки
                setupEmergencyLoader();
                
            } catch (error) {
                window.GreenLightApp.log('Loader', `Необработанная ошибка: ${error.message}`, true);
                showErrorScreen(error.message);
            }
        });
        
        // Загрузка Telegram API
        function loadTelegramApi() {
            return new Promise((resolve, reject) => {
                window.GreenLightApp.log('Loader', 'Загрузка Telegram WebApp API');
                
                const script = document.createElement('script');
                script.src = 'https://telegram.org/js/telegram-web-app.js';
                script.async = true;
                
                script.onload = function() {
                    window.GreenLightApp.log('Loader', 'Telegram WebApp API загружен');
                    resolve();
                };
                
                script.onerror = function() {
                    const errorMsg = 'Ошибка загрузки Telegram WebApp API';
                    window.GreenLightApp.log('Loader', errorMsg, true);
                    // Продолжаем загрузку даже при ошибке Telegram API
                    resolve();
                };
                
                document.body.appendChild(script);
            });
        }
        
        // Загрузка вспомогательных скриптов
        function loadBootstrapScripts() {
            return new Promise((resolve, reject) => {
                window.GreenLightApp.log('Loader', 'Загрузка вспомогательных скриптов');
                
                const loaderScript = document.createElement('script');
                loaderScript.src = 'js/loader.js';
                
                loaderScript.onload = function() {
                    window.GreenLightApp.log('Loader', 'Вспомогательные скрипты загружены');
                    resolve();
                };
                
                loaderScript.onerror = function() {
                    const errorMsg = 'Ошибка загрузки вспомогательных скриптов';
                    window.GreenLightApp.log('Loader', errorMsg, true);
                    reject(new Error(errorMsg));
                };
                
                document.body.appendChild(loaderScript);
            });
        }
        
        // Загрузка основного приложения
        function loadMainApp() {
            return new Promise((resolve, reject) => {
                window.GreenLightApp.log('Loader', 'Загрузка основного приложения');
                
                const mainScript = document.createElement('script');
                mainScript.src = 'js/main.js';
                
                mainScript.onload = function() {
                    window.GreenLightApp.log('Loader', 'Основное приложение загружено');
                    
                    // После загрузки main.js начинаем загрузку игр в фоновом режиме
                    loadGameScriptsAsync();
                    
                    resolve();
                };
                
                mainScript.onerror = function() {
                    const errorMsg = 'Ошибка загрузки основного приложения';
                    window.GreenLightApp.log('Loader', errorMsg, true);
                    reject(new Error(errorMsg));
                };
                
                document.body.appendChild(mainScript);
            });
        }
        
        // Асинхронная загрузка игровых скриптов (не блокирует основной поток)
        function loadGameScriptsAsync() {
            window.GreenLightApp.log('Loader', 'Начало загрузки игровых скриптов (фоновый режим)');
            
            const gameScripts = [
                { name: 'slots', path: 'js/games/slots.js' },
                { name: 'miner', path: 'js/games/miner.js' },
                { name: 'coinflip', path: 'js/games/coinflip.js' },
                { name: 'crush', path: 'js/games/crush.js' }
            ];
            
            gameScripts.forEach(gameInfo => {
                const script = document.createElement('script');
                script.src = gameInfo.path;
                script.async = true;
                
                script.onload = function() {
                    window.GreenLightApp.log('Loader', `Игра ${gameInfo.name} загружена`);
                };
                
                script.onerror = function() {
                    window.GreenLightApp.log('Loader', `Ошибка загрузки игры ${gameInfo.name}`, true);
                };
                
                document.body.appendChild(script);
            });
        }
        
        // Аварийная система удаления экрана загрузки
        function setupEmergencyLoader() {
            // Принудительное удаление экрана загрузки через 10 секунд
            setTimeout(function() {
                const loadingOverlay = document.getElementById('loadingOverlay');
                const appContent = document.getElementById('app-content');
                
                if (loadingOverlay && loadingOverlay.style.display !== 'none') {
                    window.GreenLightApp.log('EmergencyLoader', 'Аварийное удаление экрана загрузки', true);
                    
                    // Проверка и отображение ошибок
                    if (window.GreenLightApp.loading.errors.length > 0) {
                        showErrorScreen('Превышено время ожидания загрузки');
                        return;
                    }
                    
                    // Принудительно показываем контент
                    if (loadingOverlay) {
                        loadingOverlay.style.display = 'none';
                    }
                    
                    if (appContent) {
                        appContent.classList.add('loaded');
                    }
                    
                    // Активируем welcome-screen
                    const welcomeScreen = document.getElementById('welcome-screen');
                    if (welcomeScreen) {
                        document.querySelectorAll('.screen').forEach(screen => {
                            screen.classList.remove('active');
                        });
                        welcomeScreen.classList.add('active');
                    }
                }
            }, 10000); // 10 секунд максимум
            
            // Промежуточная проверка загрузки через 5 секунд
            setTimeout(function() {
                const loadingStatus = {
                    scriptsLoaded: window.GreenLightApp.loading.scriptsLoaded,
                    mainInitialized: window.GreenLightApp.loading.mainInitialized,
                    errors: window.GreenLightApp.loading.errors.length
                };
                
                window.GreenLightApp.log('EmergencyLoader', `Статус загрузки через 5 сек: ${JSON.stringify(loadingStatus)}`);
                
                // Обновляем прогресс
                const progressBar = document.getElementById('progress-bar');
                if (progressBar) {
                    progressBar.style.width = '70%';
                }
                
            }, 5000);
        }
        
        // Отображение экрана ошибки
        function showErrorScreen(errorMessage) {
            const errorContainer = document.getElementById('error-container');
            const errorMessageElement = document.getElementById('error-message');
            const loadingOverlay = document.getElementById('loadingOverlay');
            
            if (errorContainer && errorMessageElement) {
                errorMessageElement.textContent = errorMessage || 'Произошла ошибка при загрузке приложения';
                errorContainer.style.display = 'flex';
                
                if (loadingOverlay) {
                    loadingOverlay.style.display = 'none';
                }
            }
        }
        
        // Обновление прогресса загрузки
        function updateLoadingProgress(percent) {
            const progressBar = document.getElementById('progress-bar');
            if (progressBar) {
                progressBar.style.width = percent + '%';
            }
        }
        
        // Инициализация с обновлением прогресса
        updateLoadingProgress(10);
    </script>
    
    <!-- Добавляем скрипт для функциональности профиля -->
    <script>
        // Функции профиля - будут включены в main.js
        document.addEventListener('DOMContentLoaded', function() {
            // При загрузке добавляем обработчик для кнопки профиля
            const profileBtn = document.getElementById('profile-btn');
            if (profileBtn) {
                profileBtn.addEventListener('click', function() {
                    // Скрываем все экраны
                    document.querySelectorAll('.screen').forEach(screen => {
                        screen.classList.remove('active');
                    });
                    
                    // Показываем экран профиля
                    const profileScreen = document.getElementById('profile-screen');
                    if (profileScreen) {
                        profileScreen.classList.add('active');
                        
                        // Обновляем данные профиля
                        initProfileScreen();
                    }
                    
                    // Обновляем активную кнопку навигации
                    document.querySelectorAll('.nav-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    this.classList.add('active');
                });
            }
        });
        
        // Функция инициализации экрана профиля
        function initProfileScreen() {
            // Загружаем данные активности из localStorage
            loadActivityData();
            
            // Обновляем отображаемый баланс
            updateProfileBalance();
            
            // Настраиваем обработчики событий
            setupProfileHandlers();
        }
        
        // Загрузка данных активности
        function loadActivityData() {
            // Проверяем дату последнего сброса
            const today = new Date().toDateString();
            const lastReset = localStorage.getItem('lastActivityReset');
            
            // Если новый день или первый запуск, сбрасываем счетчик
            if (lastReset !== today) {
                window.GreenLightApp.user.activity.dailyRolled = 0;
                localStorage.setItem('lastActivityReset', today);
                localStorage.setItem('dailyRolled', '0');
            } else {
                // Иначе загружаем сохраненное значение
                const savedRolled = localStorage.getItem('dailyRolled');
                window.GreenLightApp.user.activity.dailyRolled = savedRolled ? parseInt(savedRolled) : 0;
            }
            
            // Загружаем общее количество очков активности
            const activityPoints = localStorage.getItem('activityPoints');
            if (activityPoints) {
                window.GreenLightApp.user.activity.points = parseInt(activityPoints);
            }
            
            // Обновляем отображение
            updateActivityDisplay();
        }
        
        // Обновление отображения активности
        function updateActivityDisplay() {
            const activityPoints = document.getElementById('activity-points');
            const activityProgress = document.getElementById('activity-progress');
            
            if (activityPoints) {
                activityPoints.textContent = window.GreenLightApp.user.activity.points;
            }
            
            if (activityProgress) {
                // Максимальное количество для заполнения шкалы (15000 звезд)
                const maxDailyActivity = 15000;
                
                // Рассчитываем процент заполнения
                const percentage = Math.min(100, (window.GreenLightApp.user.activity.dailyRolled / maxDailyActivity) * 100);
                
                // Обновляем ширину полосы
                activityProgress.style.width = percentage + '%';
            }
        }
        
        // Обновление баланса в профиле
        function updateProfileBalance() {
            const balanceValue = document.getElementById('profile-balance-value');
            
            if (balanceValue) {
                // Отображаем баланс в формате 2.02 (деление на 100)
                balanceValue.textContent = (window.GreenLightApp.user.balance / 100).toFixed(2);
            }
        }
        
        // Настройка обработчиков для элементов профиля
        function setupProfileHandlers() {
            // Обработчик кнопки пополнения
            const depositBtn = document.querySelector('.deposit-button');
            if (depositBtn) {
                depositBtn.addEventListener('click', function() {
                    alert('Функция пополнения будет доступна в ближайшее время');
                });
            }
            
            // Обработчик кнопки вывода
            const withdrawBtn = document.querySelector('.withdraw-button');
            if (withdrawBtn) {
                withdrawBtn.addEventListener('click', function() {
                    alert('Функция вывода будет доступна в ближайшее время');
                });
            }
            
            // Обработчик ввода промокода
            const promoInput = document.getElementById('promo-code');
            if (promoInput) {
                promoInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        applyPromoCode(this.value);
                    }
                });
            }
        }
        
        // Добавление активности (при вращении звезд)
        function addActivityPoints(amount) {
            // Добавляем к дневному счетчику прокрученных звезд
            window.GreenLightApp.user.activity.dailyRolled += amount;
            localStorage.setItem('dailyRolled', window.GreenLightApp.user.activity.dailyRolled.toString());
            
            // Рассчитываем бонусные очки (1 очко за каждые 100 звезд)
            const bonusPoints = Math.floor(amount / 100);
            window.GreenLightApp.user.activity.points += bonusPoints;
            localStorage.setItem('activityPoints', window.GreenLightApp.user.activity.points.toString());
            
            // Обновляем отображение
            updateActivityDisplay();
            
            return bonusPoints;
        }
        
        // Применение промокода
        function applyPromoCode(code) {
            if (!code) return;
            
            // Здесь должна быть логика проверки промокода
            // Для демонстрации используем фиксированные коды
            const promoCodes = {
                'WELCOME': 500,
                'BONUS50': 50,
                'VIP100': 100
            };
            
            if (promoCodes[code]) {
                // Добавляем бонус к балансу
                window.GreenLightApp.user.balance += promoCodes[code];
                
                // Обновляем отображаемый баланс
                document.getElementById('balance-amount').textContent = window.GreenLightApp.user.balance;
                updateProfileBalance();
                
                // Добавляем активность
                const bonusActivity = addActivityPoints(promoCodes[code]);
                
                alert(`Промокод ${code} успешно применен! Вы получили ${promoCodes[code]} звезд и ${bonusActivity} очков активности.`);
            } else {
                alert('Неверный промокод или срок его действия истек');
            }
            
            // Очищаем поле ввода
            document.getElementById('promo-code').value = '';
        }
    </script>
</body>
</html>